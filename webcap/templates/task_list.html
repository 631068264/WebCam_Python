{% extends "base.html" %}
{% block title %}任务列表{% endblock %}
{% block body %}
    <a href="{{ url_for('task.task_add_load') }}" class="btn btn-primary pull-right">添加任务<span
            class="glyphicon glyphicon-plus" aria-hidden="true"></span></a>
    <table class="table table-striped table-hover table-condensed ">
        <caption><strong><h3>{{ session[const.SESSION.KEY_ADMIN_NAME] }}__任务表</h3></strong></caption>
        <tr>
            <th>任务ID</th>
            <th>创建时间</th>
            <th>执行时间</th>
            <th>完成时间</th>
            <th>持续时间</th>
            <th>时间间隔</th>
            <th>当天执行</th>
            <th>资源类型</th>
            <th>目标设备</th>
            <th>任务状态</th>
            <th>操作</th>
        </tr>
        {% for t in tasks %}
            <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.create_time }}</td>
                <td>{{ t.execute_time }}</td>
                <td>{{ t.finish_time }}</td>
                <td>{{ t.duration }}</td>
                <td>{{ t.interval }}</td>
                <td>{{ const.BOOLEAN.NAME_DICT[t.now] }}</td>
                <td>
                    <select name="device_id" select_type="device" task_id="{{ t.id }}">
                        {% for d in devices %}
                            <option value="{{ d.id }}"
                                    {% if d.id== t.device_id %} selected {% endif %}
                                    >{{ d.name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td>{{ const.TASK.STATUS.NAME_DICT[t.status] }}</td>
                <td>
                    <a href="#" type="button" btn_type="delete" class="btn btn-primary" task_id="{{ t.id }}">删除<span
                            class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
                </td>
            </tr>

        {% endfor %}

    </table>
{% endblock body %}
{% block tail_js %}
    {{ super() }}
    <script>
        //删除任务
        $('a[btn_type="delete"]').click(function () {
            var task_id = $(this).attr("task_id");
            var flag = confirm("真的要删除?");

            if (flag) {
                $(this).addClass('disabled');
                console.log(task_id);
                $.get(
                        "/webcap/task/cancel",
                        {task_id: task_id},
                        function (resp) {
                            if (resp.status == 1) {
                                location.reload();
                                $(this).removeClass('disabled');
                                ok("删除成功");
                            } else {
                                error(resp.message);
                            }
                        }
                ).fail(function () {
                            $(this).removeClass('disabled');
                            error('网络故障 请检查网络连接!');
                        });
            }
        });
        //改变设备
        $('select[select_type="device"]').blur(function () {
            var task_id = $(this).attr('task_id');
            var device_id = $(this).val();
            var devive_name = $('#device option:selected').text();
            console.log(device_id + ":" + devive_name);
            var flag = confirm("是否将设备修改为：" + devive_name);
            if (flag) {
                $.get(
                        "/webcap/task/change/device",
                        {device_id: device_id, task_id: task_id},
                        function (resp) {
                            if (resp.status == 1) {
                                location.reload();
                                ok("修改成功");
                            } else {
                                error(resp.message);
                            }
                        }
                ).fail(function () {
                            error('网络故障 请检查网络连接!');
                        });
            }
        });
    </script>
{% endblock tail_js %}